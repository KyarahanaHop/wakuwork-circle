# WakuWork Circle 仕様コア

> **Version**: v0.1  
> **Updated**: 2026-02-02  
> **Authority**: このファイルが仕様の最終権威。矛盾時は本ファイルを正とする。

---

## 1. 目的

配信者が「作業セッション部屋」を立て、視聴者が入室して **同席作業 + 応援** できるWebサービス。

### 1.1 非目的（MVPでやらないこと）

- 決済実装（応援はスタブ）
- ランキング機能
- 交換性（応援で機能解放・優先権等）
- 運営による常時監視
- 通話機能
- 視聴者間DM

---

## 2. 用語定義

| 用語            | 定義                                                                                                           |
| --------------- | -------------------------------------------------------------------------------------------------------------- |
| **Room**        | 配信者の「器」。データモデルでは1人が複数所有可能だが、MVP UIでは配信者1人につき1つだけ作成/表示する。永続的。 |
| **Session**     | 配信1回分。Room内で開始/終了される。一時的。                                                                   |
| **SessionCode** | セッション参加用の英数字コード。**自動生成**（配信者は変更不可）。                                             |
| **Passphrase**  | セッション参加用の合言葉。**配信者が単語で手動設定・手動更新**。**ON/OFF切替可能**（初期値: ON）。             |
| **JoinRequest** | ロビーでの参加承認待ち状態。                                                                                   |
| **Member**      | セッションに承認済みで参加中のユーザー。                                                                       |
| **Lobby**       | 承認待ちの待機場所。ルーム初回参加者は必ず経由。                                                               |

---

## 3. 認証とアクセス

### 3.1 OAuth（MVP固定）

- **方式**: **Discord OAuth のみ**
- **視聴者ログイン**: **必須**（匿名参加不可）
- **配信者ログイン**: 必須

> **✅ 実装完了（2026-02-03時点）**
>
> TASK-001〜TASK-006 が完了し、以下が実装済み:
>
> | 項目             | 実装状況                            |
> | ---------------- | ----------------------------------- |
> | 認証方式         | Discord OAuth（NextAuth v5）        |
> | ユーザー識別     | Discord OAuth ID                    |
> | セッション管理   | Supabase + Prisma                   |
> | Room/Session管理 | DB + API Routes                     |
> | Member状態管理   | カテゴリ/短文/完了ボタン            |
> | スタンプ         | レート制限付きポーリング            |
> | OBS Overlay      | API + ページ（認証不要、D-012参照） |
> | 休憩ひとこと     | フィード形式（D-013参照）           |
>
> **次タスク**: `TASK-007: デプロイ準備`（予定）

### 3.2 閲覧専用ゲスト（D-004）

| 項目               | 仕様                               |
| ------------------ | ---------------------------------- |
| **閲覧だけゲスト** | **なし**（提供しない）             |
| **入室要件**       | **全員OAuth必須**                  |
| **外部閲覧**       | **提供しない**（ウォッチャー対策） |

**理由**:

- ウォッチャー（覗き見）による治安悪化を防止
- 全員がアカウント紐付きであることでモデレーションが機能する
- 匿名閲覧者がいると配信者・参加者が不安になる

**例外: OBS Overlay（D-012参照）**:

- `/overlay/[code]` と `GET /api/overlay?code=XXX` は認証不要
- 返却データは集計値のみ（個人情報は一切含まない）
- セッションコードを知っている人のみアクセス可能

### 3.3 ルーム公開範囲（MVP固定）

| 項目               | 仕様                                                                      |
| ------------------ | ------------------------------------------------------------------------- |
| **ルーム一覧**     | **なし**（MVP）                                                           |
| **キーワード検索** | **なし**（MVP）                                                           |
| **アクセス方法**   | **セッションコード入力（=ID入力）のみ**。コードを知っている人のみ入室可能 |

**理由**: オープンな場を作る前に「知り合い限定」の動作を検証する。参加は配信者が伝えたセッションコードを入力するのみ—検索・発見機能は存在しない。

---

## 4. 可視性（誰が誰を見れるか）

### 4.1 配信者に見える情報

| 情報                   | 可視性     |
| ---------------------- | ---------- |
| OAuth実ID（Discord名） | 常に見える |
| ニックネーム           | 設定時のみ |
| ルーム初回フラグ       | 常に見える |
| 参加履歴（Pro）        | 30日保持   |

### 4.2 視聴者同士の可視性

**デフォルト: 匿名**（視聴者同士はお互いの実IDを見えない）

配信者設定で以下の表示名モードを選択:

| Mode   | 表示名         | 説明                                                       |
| ------ | -------------- | ---------------------------------------------------------- |
| Mode 1 | `参加者#N`     | 完全匿名。入室順の番号のみ。                               |
| Mode 2 | ニックネーム   | ユーザー設定のニックネーム表示。                           |
| Mode 3 | 動物・魚・鳥名 | 独自辞書から生成。セッション内固定、セッション跨ぎで変化。 |

### 4.3 Mode 3 生成規則

- **辞書**: 独自作成（Google等の実装を参照しない）
- **固定性**: 同一セッション内ではリロードしても同じ名前
- **可変性**: セッションが変わると名前も変わる
- **生成元**: `userId + sessionId` のハッシュから決定論的に選択

---

## 5. 作業中インタラクション

**作業中はチャット禁止。以下のみ許可:**

### 5.1 スタンプ（MVP固定4種）

| ID       | 表示名 | 用途             |
| -------- | ------ | ---------------- |
| `wave`   | 挨拶   | 入室・退室の挨拶 |
| `like`   | いいね | 共感・応援       |
| `alert`  | ！     | 注目・警告       |
| `sleepy` | 眠い   | 疲労・眠気の表明 |

- **レート制限**: 未決（→ open-questions.md）
- **追加**: MVPでは4種固定。追加はPro機能検討対象。

### 5.2 作業カテゴリ + 短文

| フィールド | 必須 | 説明                                                              |
| ---------- | ---- | ----------------------------------------------------------------- |
| カテゴリ   | 必須 | プリセットから選択: **練習 / 勉強 / 制作 / 作業 / 休憩 / その他** |
| 短文       | 任意 | 自由入力。空でも可。                                              |

**更新ルール**: いつでも変更可。変更は即時反映。

### 5.3 完了ボタン

**定義**: 「いまの宣言が終わった」を報告するボタン

| 項目     | 仕様                                              |
| -------- | ------------------------------------------------- |
| 回数制限 | 同一ユーザーはセッション内で1回だけ完了状態を持つ |
| 取消     | 可能（トグル動作）                                |
| 集計     | `completedCount` = 完了=true の人数               |

**用途**: 配信者が参加者の進捗を把握する指標。

---

## 6. 休憩ひとこと（D-013）

**コンセプト**: "会話"ではなく"ひとことフィード"。返信/スレッド禁止（互恵性を作らない）。

> **✅ 実装完了（TASK-006）**

### 6.1 投稿条件

| 条件     | 仕様                                         |
| -------- | -------------------------------------------- |
| 認証     | ログイン必須                                 |
| 参加状態 | approved member のみ（pending不可）          |
| state    | **break のみ**（working/ended では投稿不可） |

### 6.2 投稿制限

| 項目       | 仕様                       |
| ---------- | -------------------------- |
| レート制限 | 5秒に1投稿/ユーザー        |
| 文字数     | **30文字以内**             |
| 改行       | **禁止**                   |
| 空投稿     | **禁止**（空白のみも不可） |
| ミュート   | 投稿不可（閲覧のみ）       |

### 6.3 表示

| 項目       | 仕様                                     |
| ---------- | ---------------------------------------- |
| 表示件数   | 最新 **20件** のみ                       |
| 表示条件   | break中のみ表示（working/endedで非表示） |
| ポーリング | 2秒間隔                                  |
| 個人情報   | 表示しない（匿名フィード）               |

### 6.4 永続化

- DBに保存（BreakMessageモデル）
- セッション終了時の削除は任意（MVPでは不要）

---

## 7. 応援

### 7.1 MVP実装

**スタブ実装**（決済なし、UIのみ）

- プリセット金額: 300 / 500 / 1000 / 3000 円
- 実際の決済処理なし

### 7.2 交換性禁止（絶対条件）

**応援で以下を与えない:**

| 禁止項目   | 理由                     |
| ---------- | ------------------------ |
| 機能解放   | 金額による差別を作らない |
| 優先権     | 金額による差別を作らない |
| 通話権     | 金額による差別を作らない |
| ランキング | 煽り・競争を防ぐ         |
| 累計表示   | 煽り・競争を防ぐ         |

**代わりに提供:**

- 演出（アニメーション、エフェクト、サウンド）
- 応援メッセージの表示

### 7.3 応援メッセージ

| 項目       | 仕様             |
| ---------- | ---------------- |
| 最大文字数 | **30文字**       |
| 改行       | **禁止**         |
| 必須       | 任意（空でも可） |

### 7.4 応援者一覧（煽り防止ルール）

| 項目           | 仕様                                                             |
| -------------- | ---------------------------------------------------------------- |
| **表示順**     | 時系列のみ（新しい順）。**並べ替え禁止**。                       |
| **ランキング** | **禁止**（1位/2位などの序列表示不可）                            |
| **合計表示**   | **禁止**（「応援合計¥X」等の表示不可）                           |
| **上位表示**   | **禁止**（「トップ3」等の絞り込み表示不可）                      |
| **金額表示**   | **視聴者・配信者両方に表示**                                     |
| **表示件数**   | 最新 **10件**（推奨）                                            |
| **応援者名**   | [可視性設定](#42-視聴者同士の可視性)（匿名/ニック/動物名）に従う |

#### 金額表示ポリシー（決定: すべての閲覧者に表示）

| 閲覧者     | 金額表示         | 備考                                           |
| ---------- | ---------------- | ---------------------------------------------- |
| **視聴者** | **あり**（表示） | 時系列固定、ランキングなし、合計なしで煽り防止 |
| **配信者** | **あり**（表示） | 収益把握のため                                 |

**表示内容（全閲覧者共通）**: 表示名 + **金額** + 時刻

**禁止事項（煽り防止）**:

- 金額による並べ替え（ソート）
- ランキング形式（1位/2位/3位）
- 合計金額の表示
- 「上位N件」などの絞り込み
- 応援回数の表示（「X回応援」等）
- **「もっと応援しろ圧」を誘発する演出・UI**（例: 進捗バー、目標金額表示、応援促進メッセージ）

> **参照**: `decisions.md` D-001

---

## 8. モデレーション

詳細は `moderation.md` を参照。

| アクション     | 効果                                           |
| -------------- | ---------------------------------------------- |
| **Kick**       | セッションから退出。再入室ルールは配信者選択。 |
| **Mute**       | 全アクション禁止（閲覧のみ）。期間指定可。     |
| **Ban (Room)** | ルーム単位で永久禁止。全セッションに適用。     |
| **Report**     | 運営への通報。MVPはDB記録 + 配信者履歴閲覧。   |

---

## 9. ログ保持

| 項目         | Free | Pro                           |
| ------------ | ---- | ----------------------------- |
| 参加履歴     | なし | 30日                          |
| 治安監査ログ | なし | 30日                          |
| 応援ログ     | なし | 30日（将来）                  |
| 発言ログ     | なし | ピン保存のみ（PinnedMessage） |

**発言はピン保存のみ**: 配信者が明示的に保存したメッセージのみ永続化。

---

## 10. 参照先

| ドメイン           | 参照ファイル                       |
| ------------------ | ---------------------------------- |
| ドメインモデル     | `docs/ssot/domain-model.md`        |
| フロー             | `docs/ssot/flows.md`               |
| 可視性詳細         | `docs/ssot/identity-visibility.md` |
| モデレーション詳細 | `docs/ssot/moderation.md`          |
| Pro保持            | `docs/ssot/pro-retention.md`       |
| 未決事項           | `docs/ssot/open-questions.md`      |
