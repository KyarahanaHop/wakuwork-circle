# フロー定義

> **Version**: v0.1  
> **Updated**: 2026-02-02  
> **Authority**: ユーザーフローの権威ファイル。

---

## 1. 参加フロー

```
[視聴者] セッションコード入力
    ↓
[システム] コード検証
    ↓ (valid)
[視聴者] 合言葉入力
    ↓
[システム] 合言葉検証
    ↓ (match)
[システム] ルーム初回判定
    ↓
┌─────────────────────────────────────┐
│ 初回 OR 承認ON → ロビー（承認待ち） │
│ 2回目以降 AND 承認OFF → 即入室      │
└─────────────────────────────────────┘
    ↓ (承認 or 即入室)
[視聴者] セッション参加完了
```

### 1.1 ルーム初回ガード

**承認設定に関わらず、ルーム初回参加者は必ずロビーを経由する。**

| 条件 | 挙動 |
|------|------|
| ルーム初回 + 承認ON | ロビー → 承認待ち |
| ルーム初回 + 承認OFF | ロビー → 承認待ち（初回のみ） |
| 2回目以降 + 承認ON | ロビー → 承認待ち |
| 2回目以降 + 承認OFF | 即入室 |

### 1.2 セッションコードと合言葉

| 項目 | 生成 | 更新 |
|------|------|------|
| セッションコード | 自動（セッション作成時） | 不可 |
| 合言葉 | 配信者が手動設定 | 配信者がいつでも手動更新可 |

**合言葉更新時**: 既存参加者には影響なし。新規参加者から新しい合言葉が必要。

---

## 2. セッション状態遷移

```
[未開始] ──(開始)──→ [作業中] ←──(作業再開)──┐
                        │                    │
                    (休憩開始)            (休憩終了)
                        │                    │
                        ↓                    │
                     [休憩中] ───────────────┘
                        │
                    (セッション終了)
                        ↓
                     [終了]
```

### 2.1 状態定義

| 状態 | 許可されるアクション |
|------|---------------------|
| `working` | スタンプ、作業カテゴリ更新、短文更新、完了報告 |
| `break` | 上記 + テキストチャット |
| `ended` | 閲覧のみ（履歴として残る） |

### 2.2 操作権限

| 操作 | 配信者 | 視聴者 |
|------|--------|--------|
| 状態切り替え | OK | NG |
| 宣言更新 | OK | NG |
| 合言葉更新 | OK | NG |
| 承認/拒否 | OK | NG |
| キック/ミュート/ブロック | OK | NG |
| 通報 | OK | NG |
| スタンプ送信 | OK | OK |
| 作業内容更新 | OK | OK |
| 完了報告 | OK | OK |

---

## 3. 作業カテゴリ + 短文フロー

```
[参加者] カテゴリ選択（必須）
    ↓
[参加者] 短文入力（任意）
    ↓
[システム] 即時反映
    ↓
[他参加者] リアルタイムで表示更新
```

### 3.1 カテゴリプリセット

- 開発
- デザイン
- 勉強
- 作業
- 執筆
- その他

### 3.2 更新ルール

- いつでも変更可能
- 短文は空でも可
- 変更は即時反映（リアルタイム方式は未決）

---

## 4. スタンプフロー

```
[参加者] スタンプボタンタップ
    ↓
[システム] レート制限チェック
    ↓ (OK)
[システム] 全参加者にブロードキャスト
    ↓
[UI] スタンプアニメーション表示（数秒で消える）
```

### 4.1 初期スタンプ

| ID | 絵文字 | 意味 |
|----|--------|------|
| `wave` | [wave] | 挨拶 |
| `thumbsup` | [thumbsup] | いいね |
| `exclamation` | [exclamation] | 注目 |
| `sleepy` | [sleepy] | 眠い/疲れた |

### 4.2 レート制限

**未決** → `open-questions.md` 参照

候補:
- 1分あたり10回
- 連続送信は2秒間隔

---

## 5. ロビー（承認待ち）フロー

```
[視聴者] ロビー画面表示
    ↓
[視聴者] 承認待ち状態
    ↓
┌─────────────────────────┐
│ 配信者が承認 → 入室     │
│ 配信者が拒否 → 退出画面 │
│ タイムアウト → 退出画面 │
└─────────────────────────┘
```

### 5.1 ロビー画面に表示する情報

- ルーム名
- 配信者名
- 「承認待ちです」のメッセージ
- キャンセルボタン

### 5.2 配信者のロビー管理

- 承認待ちリスト表示
- 各ユーザーの情報: Discord名、ニック、初回フラグ
- 一括承認ボタン（オプション）
- 個別承認/拒否ボタン
