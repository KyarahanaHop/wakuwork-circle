# フロー定義

> **Version**: v0.1  
> **Updated**: 2026-02-02  
> **Authority**: ユーザーフローの権威ファイル。

---

## 1. 参加フロー

```
[視聴者] セッションコード入力
    ↓
[システム] コード検証
    ↓ (valid)
┌──────────────────────────────────────────┐
│ passphraseRequired=true?                 │
│   YES → [視聴者] 合言葉入力              │
│   NO  → (skip)                           │
└──────────────────────────────────────────┘
    ↓
[システム] 合言葉検証 (passphraseRequired=trueの場合)
    ↓ (match or skipped)
[システム] ルーム初回判定
    ↓
┌─────────────────────────────────────┐
│ 初回 OR 承認ON → ロビー（承認待ち） │
│ 2回目以降 AND 承認OFF → 即入室      │
└─────────────────────────────────────┘
    ↓ (承認 or 即入室)
[視聴者] セッション参加完了
```

### 1.1 ルーム初回ガード

**承認設定に関わらず、ルーム初回参加者は必ずロビーを経由する。**

| 条件 | 挙動 |
|------|------|
| ルーム初回 + 承認ON | ロビー → 承認待ち |
| ルーム初回 + 承認OFF | ロビー → 承認待ち（初回のみ） |
| 2回目以降 + 承認ON | ロビー → 承認待ち |
| 2回目以降 + 承認OFF | 即入室 |

### 1.2 セッションコードと合言葉

| 項目 | 生成 | 更新 |
|------|------|------|
| セッションコード | 自動（セッション作成時） | 不可 |
| 合言葉 | 配信者が手動設定 | 配信者がいつでも手動更新可 |
| 合言葉必須設定 | デフォルト: ON | 配信者がON/OFF切り替え可 |

**合言葉更新時**: 既存参加者には影響なし。新規参加者から新しい合言葉が必要。

**合言葉必須設定 (`passphraseRequired`)**:
- `true` (デフォルト): 合言葉入力が必須
- `false`: 合言葉入力をスキップ、セッションコードのみで参加可能
  - **ただし初回参加者は自動でロビー経由**（承認待ち強制）

### 1.3 セーフティロック（D-002）

**合言葉OFF + 承認OFF を同時に設定する場合**:

| 項目 | 仕様 |
|------|------|
| 許可 | **する**（設定自体は許可） |
| UI警告 | **強い警告を表示** |
| 警告文例 | 「誰でも即入室できる状態になります。荒らし対策として推奨しません。」 |

**理由**: 
- 配信者の自由度を残しつつ、リスクを明確に伝える
- 知人限定の信頼できるグループでの利用を想定

> **参照**: `decisions.md` D-002

---

## 2. セッション状態遷移

```
[未開始] ──(開始)──→ [作業中] ←──(作業再開)──┐
                        │                    │
                    (休憩開始)            (休憩終了)
                        │                    │
                        ↓                    │
                     [休憩中] ───────────────┘
                        │
                    (セッション終了)
                        ↓
                     [終了]
```

### 2.1 状態定義

| 状態 | 許可されるアクション |
|------|---------------------|
| `working` | スタンプ、作業カテゴリ更新、短文更新、完了報告（トグル） |
| `break` | 上記 + テキストチャット |
| `ended` | 閲覧のみ（履歴として残る） |

### 2.3 完了報告

| 項目 | 仕様 |
|------|------|
| 定義 | 「いまの宣言が終わった」 |
| 制限 | 1ユーザーにつきセッション内で1回のみ完了状態を持てる |
| 取消 | 可能（トグル動作：完了 ⇄ 未完了） |
| 集計 | `completedCount` = 完了状態のユーザー数

### 2.2 操作権限

| 操作 | 配信者 | 視聴者 |
|------|--------|--------|
| 状態切り替え | OK | NG |
| 宣言更新 | OK | NG |
| 合言葉更新 | OK | NG |
| 承認/拒否 | OK | NG |
| キック/ミュート/ブロック | OK | NG |
| 通報 | OK | NG |
| スタンプ送信 | OK | OK |
| 作業内容更新 | OK | OK |
| 完了報告 | OK | OK |

---

## 3. 作業カテゴリ + 短文フロー

```
[参加者] カテゴリ選択（必須）
    ↓
[参加者] 短文入力（任意）
    ↓
[システム] 即時反映
    ↓
[他参加者] リアルタイムで表示更新
```

### 3.1 カテゴリプリセット

- **練習**
- **勉強**
- **制作**
- **作業**
- **休憩**
- **その他**

### 3.2 更新ルール

- いつでも変更可能
- 短文は空でも可
- 変更は即時反映（リアルタイム方式は未決）

---

## 4. スタンプフロー

```
[参加者] スタンプボタンタップ
    ↓
[システム] レート制限チェック
    ↓ (OK)
[システム] 全参加者にブロードキャスト
    ↓
[UI] スタンプアニメーション表示（数秒で消える）
```

### 4.1 初期スタンプ（MVP固定）

| ID | 絵文字 | 表示名 | 意味 |
|----|--------|--------|------|
| `wave` | 👋 | 挨拶 | 入室・退室の挨拶 |
| `like` | 👍 | いいね | 共感・応援 |
| `alert` | ❗ | ！ | 注目・警告 |
| `sleepy` | 😪 | 眠い | 疲労・眠気の表明 |

### 4.2 レート制限

**未決** → `open-questions.md` 参照

候補:
- 1分あたり10回
- 連続送信は2秒間隔

---

## 5. ロビー（承認待ち）フロー

```
[視聴者] ロビー画面表示
    ↓
[視聴者] 承認待ち状態
    ↓
┌─────────────────────────┐
│ 配信者が承認 → 入室     │
│ 配信者が拒否 → 退出画面 │
│ タイムアウト → 退出画面 │
└─────────────────────────┘
```

### 5.1 ロビー画面に表示する情報

- ルーム名
- 配信者名
- 「承認待ちです」のメッセージ
- キャンセルボタン

### 5.2 配信者のロビー管理

- 承認待ちリスト表示
- 各ユーザーの情報: Discord名、ニック、初回フラグ
- 一括承認ボタン（オプション）
- 個別承認/拒否ボタン
